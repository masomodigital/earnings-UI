<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Earnings Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; }
    input[type=text], input[type=password] {
      width: 100%; padding: 10px; margin: 6px 0 12px 0; border: 1px solid #ccc; border-radius: 4px;
    }
    button {
      background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    table {
      border-collapse: collapse; width: 100%; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .promo-code {
      font-family: monospace; background: #eee; padding: 4px 6px; border-radius: 4px;
      cursor: pointer;
      user-select: all;
    }
    .copy-button {
      margin-left: 8px; padding: 4px 8px; font-size: 0.9em; cursor: pointer;
      border: 1px solid #888; border-radius: 4px; background: #f9f9f9;
    }
    .copy-button:hover {
      background-color: #ddd;
    }
    #error {
      color: red; margin-top: 10px;
    }
    #welcome-msg {
      font-size: 1.2em;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div id="welcome-msg" style="display:none;">
    Welcome, <span id="username" style="color:red;"></span>!
  </div>

  <h2 style="color: green;">EARNINGS DASHBOARD</h2>
  <div id="login-form">
    <label for="nationalId">National ID:</label><br>
    <input type="text" id="nationalId" placeholder="Enter National ID" required><br>
    <label for="password">Password:</label><br>
    <input type="password" id="password" placeholder="Enter Password" required><br>
    <button onclick="login()">Login</button>
    <div id="error"></div>
  </div>

  <div id="dashboard" style="display:none;">
    <h3>YOUR EARNINGS</h3>
    <p style="color: green; font-weight: bold; margin-top: 5px;">
 NB: You can withdraw your earnings if they are KSH.100 and above.
</p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Credits</th>
          <th>Phone Number</th>
          <th>Promo Code</th>
          <th>Earnings (KSH)</th>
        </tr>
      </thead>
      <tbody id="user-data">
      </tbody>
    </table>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    // IMPORTANT: Replace this with your actual Google Apps Script Web App deployment URL
    // This is the URL you provided: https://script.google.com/macros/s/AKfycbwnVJyKoqn-knXyO5ne2qnU9Xya0l5OJqtdfxUR9R7Dx3Sn-oGI8LL6fRRRVrhQLS0-ZA/exec
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwnVJyKoqn-knXyO5ne2qnU9Xya0l5OJqtdfxUR9R7Dx3Sn-oGI8LL6fRRRVrhQLS0-ZA/exec';

    async function login() {
      const nationalId = document.getElementById('nationalId').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = '';

      if (!nationalId || !password) {
        errorDiv.textContent = 'Please enter both National ID and Password.';
        return;
      }

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          // Google Apps Script `doPost` expects data as URL-encoded form data,
          // or you can parse JSON. For simplicity, we'll send it as JSON
          // and adjust `doPost` in `code.gs` if needed.
          // Your current `doLogin` function in `code.gs` expects a `data` object,
          // which is typically passed by google.script.run. We'll simulate this
          // by sending JSON in the request body.
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ nationalId: nationalId, password: password, functionName: 'doLogin' })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json(); // Parse the JSON response from your Apps Script

        if (data.success) {
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('welcome-msg').style.display = 'block';
          document.getElementById('username').textContent = data.name;
          document.getElementById('dashboard').style.display = 'block';

          const tbody = document.getElementById('user-data');
          tbody.innerHTML = ''; // Clear previous

          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.textContent = data.name;
          tr.appendChild(tdName);

          const tdCredits = document.createElement('td');
          tdCredits.textContent = data.credits;
          tr.appendChild(tdCredits);

          const tdPhone = document.createElement('td');
          tdPhone.textContent = data.phone;
          tr.appendChild(tdPhone);

          const tdPromo = document.createElement('td');
          const promoSpan = document.createElement('span');
          promoSpan.textContent = data.promo;
          promoSpan.className = 'promo-code';
          promoSpan.title = 'Click to copy promo code';
          promoSpan.onclick = function() {
            copyToClipboard(data.promo);
          };
          tdPromo.appendChild(promoSpan);

          const copyBtn = document.createElement('button');
          copyBtn.textContent = 'Copy';
          copyBtn.className = 'copy-button';
          copyBtn.onclick = function() {
            copyToClipboard(data.promo);
          };
          tdPromo.appendChild(copyBtn);

          tr.appendChild(tdPromo);

          const tdEarnings = document.createElement('td');
          tdEarnings.style.color = 'red';
          tdEarnings.textContent = Number(data.earnings).toFixed(2);
          tr.appendChild(tdEarnings);

          tbody.appendChild(tr);

        } else {
          errorDiv.textContent = data.message || 'Login failed';
        }
      } catch (error) {
        console.error('Error during login:', error);
        errorDiv.textContent = 'An error occurred during login. Please try again.';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Promo code copied: ' + text);
      }, () => {
        alert('Failed to copy promo code.');
      });
    }

    function logout() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('welcome-msg').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('nationalId').value = '';
      document.getElementById('password').value = '';
      document.getElementById('error').textContent = '';
    }
  </script>
</body>
</html>
